---

- name: Delete VM if exists
  when: "vm_name in existing_vms.list_vms"
  tags:
    - delete
  block:

    - name: Destroy VM
      community.libvirt.virt:
        command: destroy
        name: "{{ vm_name }}"

    - name: Undefine VM
      community.libvirt.virt:
        command: undefine
        name: "{{ vm_name }}"

    - name: Remove Disk
      file:
        path: "{{ libvirt_pool_dir }}/{{ vm_name }}.qcow2"
        state: absent


    - name: Remove cloud-init iso
      file:
        path: "{{ libvirt_pool_dir }}/{{ vm_name }}.iso"
        state: absent

